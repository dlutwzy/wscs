<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>设置满减送</title>
[#include "/includes/header.html" /]
<style type="text/css">
.nav-tabs li{width:200px;}
.app-image-list li {
    background-color: #fff;
    border: 1px solid #ddd;
    display: block;
    float: left;
    height: 40px;
    margin: 0 10px 10px 0;
    position: relative;
    width: 40px;
}
 .app-image-list li a {
    display: block;
    height: 100%;
}
.app-image-list li img {
    height: 100%;
    width: 100%;
}
.app-image-list li .add-goods, .app-image-list li .add {
    cursor: pointer;
    display: inline-block;
    height: 100%;
    line-height: 40px;
    text-align: center;
    width: 100%;
}
.app-image-list li:hover .close-modal {
    display: block;
}
.w30{
background-color: #fff;
    border: 1px solid #ccc;
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset;
    transition: border 0.2s linear 0s, box-shadow 0.2s linear 0s;
width: 50px;
}
.controls{
 margin-left: 160px;
}
.page-reward .reward-table-wrap {
    padding-left: 50px;
}
.page-reward .no-result {
    border: medium none;
    padding: 100px 0;
}
.page-reward .reward-table {
    width: 100%;
}
.page-reward .reward-table tr {
    border: 1px solid #ddd;
}
.page-reward .reward-table tr th {
    background: #f2f2f2 none repeat scroll 0 0;
    line-height: 36px;
}
.page-reward .reward-table tr .pl100 {
    padding-left: 100px;
    text-align: left;
}
.page-reward .reward-table tr td {
    vertical-align: middle;
}
.page-reward .reward-table tr td .w30 {
    margin: 0 5px;
    vertical-align: middle;
    width: 30px;
}
.page-reward .reward-table tr td .w120 {
    width: 120px;
}
.page-reward .reward-table tr td .reward-controls {
    line-height: 40px;
    padding-left: 20px;
}
.page-reward .reward-table tr td .reward-setting .error-message {
    display: inline-block;
    padding-left: 10px;
}
.page-reward .reward-table tr td .reward-setting .show {
    display: block;
}
.page-reward .reward-table tr td .reward-setting .hide {
    display: none;
}
.page-reward .reward-table tr td .first-reward {
    margin-top: 5px;
}
.page-reward .reward-table tr td .last-reward {
    margin-bottom: 5px;
}
.page-reward .reward-table .controls {
    /* height: 52px; */
    margin-left: 100px;
}
.page-reward .reward-table .controls span {
    display: inline-block;
    line-height: 32px;
}
.page-reward .reward-table .controls .reward-label {
    display: inline-block;
    padding-top: 0;
    vertical-align: middle;
}
.page-reward .reward-table .controls .checked-status {
    margin-top: 10px;
}
.page-reward .reward-table .controls .replace-status {
    margin-left: 0;
    padding-left: 0;
}
.page-reward .reward-table .readonly-control-group .control-group {
    margin-top: 10px;
}
.page-reward .reward-table .readonly-control-group .control-group .controls {
    height: auto;
}
.page-reward .reward-table label {
    -moz-user-select: none;
}
.page-reward .reward-table .add-reward-toolbar {
    display: none;
}
.page-reward .reward-table .error-node {
    display: none;
}
.page-reward .reward-table .reward-need-one {
    display: none;
}
.page-reward .reward-table .reward-need-one.error {
    display: block;
}
.control-group {
    margin-bottom: 10px;
}
</style>
</head>
<body class="fixed-sidebar full-height-layout gray-bg">
[#include "/includes/menus.html" /]
<div class="wrapper wrapper-content">
	<div class="row content-tabs">
		<nav class="page-tabs J_menuTabs">
	       <div class="page-tabs-content" style="margin-left: 0px;">
	           <a href="${webctx}/promotion" class="J_menuTab">限时打折</a>
		       <!-- <a href="${webctx}/cashback" class="J_menuTab">订单返现</a> -->
		       <a href="${webctx}/reward" class="J_menuTab active">满减送</a>
	       </div>
	   	</nav>
	</div>
	<div class="ibox float-e-margins">
		<div class="ibox-title row">
			<h5><small><a href="${webctx}/reward">《返回列表</a></small></h5>
		</div>
		<div class="row ibox-content active_statistics col-sm-9">
		<div class="title_query padtop">
			<form id="cashbackForm" class="form-horizontal">
				<input type="hidden" name="id" id="id" value="${fullCutDto.id }"/>
				<div class="form-group">
		            <label class="col-md-2 control-label">活动名称<span style="color: red;"><em>*</em></span></label>
		            <div class="col-md-8" id="error_name">
		                <input id="name" name= "name" value="${fullCutDto.name}" maxlength="20" type="text" class="form-control" style="width: 400px" >
		                <label class="control-label" for="name"></label>
		            </div>
		        </div>
		        <div class="form-group">
		            <label class="col-md-2 control-label">生效时间<span style="color: red;"><em>*</em></span></label>
		            <div class="col-sm-9">
	                   	<div class="row">
	                   		[#if fullCutDto??]
		                   		<div class="col-lg-3 col-md-3" id="error_start_date">
			                        <input type="text" id="start_date" name="start_date" class="form-control" readonly="readonly" style="width: 160px;" value="${fullCutDto.startDate}" />
									<label class="control-label" for="start_date"></label>
			                    </div>
			                    <div class="col-lg-3 col-md-3" id="error_end_date">
			                        <input type="text" id="end_date" name="end_date" class="form-control" readonly="readonly" style="width: 160px;" value="${fullCutDto.endDate}" />	
									<label class="control-label" for="end_date"></label>
			                    </div>
	                   		[#else]
								<div class="col-lg-3 col-md-3" id="error_start_time">
			                        <input type="text" id="start_date" name="start_time" readonly="readonly" style="width: 160px;"
									onfocus="WdatePicker({skin:'twoer', isShowClear:false,readOnly:true,dateFmt:'yyyy-MM-dd %H:%m:%s',minDate:'%y-%M-%d %H:%m:%s',maxDate:'#F{$dp.$D(\'end_date\')}'})"
									class="Wdate" value="" />
									<label class="control-label" for="start_date"></label>
			                    </div>
			                    <div class="col-lg-3 col-md-3" id="error_end_time">
			                        <input type="text" id="end_date" name="end_time" readonly="readonly" style="width: 160px;"
									onfocus="WdatePicker({skin:'twoer', isShowClear:false,readOnly:true,dateFmt:'yyyy-MM-dd %H:%m:%s',minDate:'#F{$dp.$D(\'start_date\',{d:7});}'})"
									class="Wdate" value="" />	
									<label class="control-label" for="end_date"></label>
			                    </div>	
			                    <div class="col-lg-3 col-md-3">
			                    	<a class="label label-default" href="javascript:dateTimeTag(7);">一周</a>
			                    	<a class="label label-default" href="javascript:dateTimeTag(15);">半个月</a>
			                    </div>                   		
	                   		[/#if]
		                </div>
		            </div>
		        </div>
		        
		        <div class="form-group">
		            <label class="col-md-2 control-label">优惠条件<span style="color: red;"><em>*</em></span></label>
		            <div class="col-md-9 page-reward" id="error_name">
		               <div class="reward-table-wrap">
							<table class="reward-table">
								<thead>
									<tr>
										<th width="35%">优惠门槛</th>
										<th class="pl100" width="55%">优惠方式(可多选)</th>
										<th width="10%">操作</th>
									</tr>
								</thead>
							  <tbody id="reward-condition">
							  [#if fullCutDto??]
							  [#list fullCutDto.sets as setItem]
							  <tr>
							        <input class="span form-control" name="set_id" value="${setItem.id}" type="hidden">
									<td align="center">
										<div class="control-group">
										<div class="controls" style="margin:0;">
										<span>满</span>
										<input class="span form-control" name="meet" value="${setItem.meet}" type="text" style="width: 80px;" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')">
										<span>元</span>
										</div>
										</div>
									</td>
									<td>
									 <div class="control-group reward-setting first-reward">
										<div class="controls">
										<label class="checkbox inline reward-label js-trigger-label">
										<input class="checked-status" name="cash_required" type="checkbox" value="1" onclick="checkStatus(this);" [#if setItem.cash_required==1] checked="checked" [/#if]>
										
										 [#if setItem.cash_required==1]
										 <span class="replace-status js-response-label">
										减
										<input class="span1 js-valid-input form-control" name="cash" value="${setItem.cash}" style="width: 80px;" type="text" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')">
										元
										</span>
										 [#else]
										 <span class="origin-status " style="display: inline-block;">减现金</span>
										 <span class="replace-status js-response-label" style="display: none;">
										减
										<input class="span1 js-valid-input form-control" name="cash" value="${setItem.cash}" style="width: 80px;" type="text" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')">
										元
										</span>
										 [/#if]
										
										
										</label>
										</div>
									</div>
									<div class="control-group reward-setting">
										<div class="controls">
										<label class="checkbox inline reward-label">
										<input class="checked-status" name="postage" type="checkbox" value="1" [#if setItem.postage==1] checked="checked" [/#if]>
										<span class="origin-status">免邮</span>
										</label>
										</div>
									</div>
									<label class="status_error_msg" style="color:red;margin-left: 70px;"></label>
									</td>
									<td align="center">
									<a class="gray js-remove-item" data-id="${setItem.id}" onclick="removeObj(this);">删除</a>
									</td>
								  </tr>
								 [/#list]
								[#else]  
							    <tr>
							        <input class="span form-control" name="set_id" value="" type="hidden">
									<td align="center">
										<div class="control-group">
										<div class="controls" style="margin:0;">
										<span>满</span>
										<input class="span form-control" name="meet" value="" type="text" style="width: 80px;" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')">
										<span>元</span>
										</div>
										</div>
									</td>
									<td>
									 <div class="control-group reward-setting first-reward">
										<div class="controls">
										<label class="checkbox inline reward-label js-trigger-label">
										<input class="checked-status" name="cash_required" type="checkbox" value="1" onclick="checkStatus(this);">
										<span class="origin-status " style="display: inline-block;">减现金</span>
										<span class="replace-status js-response-label" style="display: none;">
										减
										<input class="span1 js-valid-input form-control" name="cash" value="" style="width: 80px;" type="text" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')">
										元
										</span>
										
										</label>
										</div>
									</div>
									<div class="control-group reward-setting">
										<div class="controls">
										<label class="checkbox inline reward-label">
										<input class="checked-status" name="postage" type="checkbox" value="1">
										<span class="origin-status">免邮</span>
										</label>
										</div>
									</div>
									<label class="status_error_msg" style="color:red;margin-left: 70px;"></label>
								    </td>
								  </tr>
								  [/#if]
							  </tbody>
							 <tfoot class="add-reward-toolbar" style="display: table-footer-group;">
                             <tr> 
							  <td colspan="5">
	                            <div class="reward-controls">
	                            <a href="javascript:addReward()" class="js-add-reward">+新增优惠</a>
	                            <!-- <span class="gray pl20">最多可设置五个层级</span> -->
	                           </div>
                              </td>
                              </tr>
                              </tfoot>
						</table> 
		            </div>
		        </div>
		      </div>   
		      
		      <ol class="breadcrumb">
					<li><i class="fa fa-home"></i><a href="javascript:selectProduct();">选择活动商品</a></li>
				</ol>
			 <div class="panel-body">
                      <table class="table table-striped table-bordered bootstrap-datatable datatable"  border="0" style="width: 80%">
								<thead>
									<tr>
										<th><span style="vertical-align: middle;">&nbsp;&nbsp;商品</span></th>
										<th>价格</th>
										<th>库存</th>
										<th>操作</th>
									</tr>
								</thead>
								<tbody class="seletctProductLotGrid">
								</tbody>
						</table>
			 </div>	
		  </form>
		  
		  <div class="panel-footer" align="center">
		   	 	<button type="button" onclick="saveCashback();" class="btn btn-sm btn-success"><i class="fa fa-dot-circle-o"></i>提交</button>
			</div>
		 </div>
		</div>
	</div>
</div>
<div class="modal fade" id="selectProduct">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">选择活动商品</h4>
			</div>
			<div class="modal-body">    
		       		<div id="myTabContent" class="tab-content">
						<div class="tab-pane active" id="select_items_div">
							<table class="table table-striped table-bordered bootstrap-datatable datatable" id="mainTable" border="0" style="width: 100%">
								<thead>
									<tr>
										<th><input type="checkbox" id="all" title="全选/反选" style="margin-right: 4px; vertical-align: middle;"/></th>
										<th><span style="vertical-align: middle;">&nbsp;&nbsp;商品</span></th>
										<th>价格</th>
										<th>库存</th>
										<!-- <th>操作</th> -->
									</tr>
								</thead>
								<tbody class="productLotGrid">
								</tbody>
							</table>
							<div id="productToolsbar" class="panel-body">
								<div id="pager" class="jqpager" style="margin-bottom: 1px;float: right;"></div>
							</div>
						</div>
					</div>
			</div>
			<div class="modal-footer" >
			<div  style="display: block;" align="center">
				<button id="selectAllProduct" type="button" class="btn btn-sm btn-primary">确      定</button>	
			</div>	
        	</div>
		</div>
	</div>
</div>
<script type="text/javascript">
var itemsAll = new Array();
function saveCashback(){
	var params = {}, error = {};
	var  name = $("#name").val(),start_date = $("#start_date").val(), end_date = $("#end_date").val(),id=$("#id").val();
	params.id=id;
	if($.trim(name) =="") {error.error_name = "活动名称不能为空"; } else {error.error_name=""; params.name = $.trim(name);}
	if($.trim(start_date) =="") {error.error_start_time = "开始时间不能为空"; } else {error.error_start_time =""; params.start_date = $.trim(start_date);}
	if($.trim(end_date) =="") {error.error_end_time = "结束时间不能为空"; } else { error.error_end_time=""; params.end_date = $.trim(end_date);}
	var hasErr = false;
	$("#reward-condition tr").each(function(i,obj){
 		var meet = $(obj).find("input[name='meet']");
 		if(meet.val()==""){	
 			if(!hasErr) hasErr=true;
 			meet.css("border-color", "#ff5454");
		}
 		
 		if($(obj).find("input[name='cash_required']").is(':checked')||$(obj).find("input[name='postage']").is(':checked')){
 			
 		}else{
 			if(!hasErr) hasErr=true;
 			$(obj).find(".status_error_msg").html("优惠方式不能为空");
 		}
 		
 		if($(obj).find("input[name='cash_required']").is(':checked')){
 			var cash = $(obj).find("input[name='cash']");
 	 		if(cash.val()==""){	
 	 			if(!hasErr) hasErr=true;
 	 			cash.css("border-color", "#ff5454");
 			}
 		}
 		
	});
	for(var key in error){
		if(error[key]!=""){
			if(!hasErr) hasErr = true;
			$("#"+key).addClass("has-error");
			$("#"+key).find("label").text(error[key]);
		}else{
			$("#"+key).removeClass("has-error");
			$("#"+key).find("label").empty();
		}
	}
	//主表信息不完整，返回
	if(hasErr) return false;
	
	$("#reward-condition tr").each(function(i,obj){
		var meet = $(obj).find("input[name='meet']").val();
		var set_id = $(obj).find("input[name='set_id']").val();
		var cash="";
		var cash_required="";
		var postage="";
		if($(obj).find("input[name='cash_required']").is(':checked')){
		cash_required=$(obj).find("input[name='cash_required']:checked").val();
 		cash = $(obj).find("input[name='cash']").val();
		}
		if($(obj).find("input[name='postage']").is(':checked')){
			postage=$(obj).find("input[name='postage']:checked").val();
		}
		
		 var entity = new Object();
		    entity.id=set_id;
		    entity.meet=meet;
			entity.cash_required = cash_required;
			entity.postage = postage;
			entity.cash= cash;
			itemsAll.push(entity);	 
	});
	params.setItem=JSON.stringify(itemsAll);
	if($(".seletctProductLotGrid").find("tr").length<=0){
		obz.showMessage("请选择商品!");
		return false;
	}else{
		var productIds="";
		$(".seletctProductLotGrid").find("tr").each(function(){
			productIds=productIds+$(this).attr("id")+"-";
		});
		params.product_ids=productIds;
	}
	
	$(".main").mask();
	$.post(obz.ctx+"/reward/save", params, function(resp) {
		$(".main").unmask();
		if(resp.code != 200){
			obz.showMessage(resp.msg);
			return;
		}
		
		obz.showMessage("保存成功", function(){
			location.href = obz.ctx + "/reward";
		});
	});
}
$(document).ready(function(){
	var productIds="${fullCutDto.productIds}"
		if(productIds!=null&&productIds!=""){
			getProducts(productIds);
		}
	$("#selectAllProduct").click(function(){
		if(TBatch.getCheckedCount() <=0){
			obz.showMessage("请选择商品!");
			return false;
		}else{
			 $("#selectProduct").modal("hide");	
			var product_ids=TBatch.getChecked();
			getProducts(product_ids);
		}
		
	});
});
//新增优惠
function addReward(){
	$("#reward-condition").append($("#reward_tr_tpl").html());
}
//删除当前优惠行
function removeObj(obj){
	var id=$(obj).attr("data-id");
	if(id){
		var params={};
		params.id=id;
		$.post(obz.ctx+"/reward/delSet", params, function(resp) {
			if(resp.code != 200){
				obz.showMessage(resp.msg);
				return;
			}else{
				$(obj).parent().parent().remove();		
			}
		});
	}else{
		$(obj).parent().parent().remove();	
	}
	
}
//是否减现金
function checkStatus(obj){
	if($(obj).is(':checked')) {
	   
		$(obj).parent().find(".origin-status").hide();
		$(obj).parent().find(".replace-status").show();
	}else{
		$(obj).parent().find(".origin-status").show();
		$(obj).parent().find(".replace-status").hide();
	}
}
//列出商品
function selectProduct(){
	 $("#selectProduct").modal("show");
}
function bindSetTableAEvent(){
	//注册取消返现商品事件
	$(".seletctProductLotGrid").find("tr a").each(function(){
		$(this).unbind("click");
		$(this).click(function(){
			var me = $(this);
			//取消设置不能直接删除该行，需要隐藏
			//me.parent().parent().attr("opt", "del");
			me.parent().parent().remove();
			$("#checkbox_"+me.attr("id")).attr("checked", false);
			//$("#_sel_total_item").html(parseInt(TBatch.getCheckedCount()) + parseInt($("#_sel_total_item").text()));
			//添加到可选商品列表
			return false;
		});
	});
}
var getProducts = function(productIds){
	var params = {};
	params.productIds=productIds;
	$("#mainTable").mask("加载中...");
	var url = obz.ctx + "/cashback/listSelectProduct";
	obz.ajaxJson(url, params, function(resp){
		$("#mainTable").unmask();
		$(".seletctProductLotGrid").empty();
		var dataList = resp.data;
		if(dataList.length>0){
			for(var i=0;i<dataList.length;i++){
				var _row = dataList[i];
				var trHtml = obz.dataTemplate4obj($("#select_product_table_tr_tpl").html(), _row);
				$(".seletctProductLotGrid").append(trHtml);
				bindSetTableAEvent();
			}
			
		}
	});
	
}
var pageClick = function(pageNo) {
	searchProducts(pageNo);
}
var searchProducts = function(currPage){
	var params = {};
	//其他查询条件
	if(currPage){
		params.page = currPage;
	}
	$("#mainTable").mask("加载中...");
	var url = obz.ctx + "/reward/listProducts";
	obz.ajaxJson(url, params, function(resp){
		$("#mainTable").unmask();
		var result = resp.data;
		$(".productLotGrid").empty();
		if(currPage){
			$("#pager").pager({ pagenumber:currPage, recordcount:result.totalRow, pagesize:result.pageSize, recordtext:'共 {0} 页, {1} 条记录', buttonClickCallback: pageClick });
		}else{
			$("#pager").pager({ recordcount:result.totalRow, pagesize:result.pageSize, recordtext:'共 {0} 页, {1} 条记录', buttonClickCallback: pageClick });	
		}
		var dataList = result.list;
		if(dataList.length>0){
			for(var i=0;i<dataList.length;i++){
				var _row = dataList[i];
				var trHtml = obz.dataTemplate4obj($("#product_table_tr_tpl").html(), _row);
				$(".productLotGrid").append(trHtml);
			}
			TBatch.checkCheckbox(function (chkAll){
				//$("#_sel_total_item").html(parseInt(TBatch.getCheckedCount()) + parseInt($("#_sel_total_item").text()));
				$("#mainTable input:checkbox.commchk").each(function(){
					if($(this).is(":checked") == true){
						//selectItem($(this));
					}else{
						//unSelectItem($(this));
					}
				});
			});
			TBatch.initCheckboxClick(function(resp){
				//selectItem($(resp));
			}, function(resp){
				//unSelectItem($(resp));
			});
		}else{
			$(".productLotGrid").append($("#table_noresult_tr_tpl").html());
		}
	});
}
searchProducts();
</script>
<!-- 选择的商品列表模板 -->
<script type="text/template" id="product_table_tr_tpl">
		<tr class="package">
			<td><input type="checkbox" class="commchk" id="checkbox_{id}" product_id="{id}" product_name="{name}" product_price="{price}" product_img="{img}" style="margin-right: 4px; vertical-align: middle;"/></td>
			<td>
			<ul class="js-picture-lists app-image-list"><li><img src="{img}" width="40px" height="40px"></li></ul>
            <p class="goods-title"><a class="new-window" href="javascript:void(0)" title="{name}">{name}</a></p>
			</td>
			<td><span class="label label-success">￥{price}</span></td>
            <td>{stock}</td>
		</tr>
</script>

<script type="text/template" id="select_product_table_tr_tpl">
		<tr id="{id}" style="height: 50px; background-color: #D3E8FE;" class="package">
			<td>
			<ul class="js-picture-lists app-image-list"><li><img src="{img}" width="40px" height="40px"></li></ul>
            <p class="goods-title"><a class="new-window" href="javascript:void(0)" title="{name}">{name}</a></p>
			</td>
			<td><span class="label label-success">￥{price}</span></td>
            <td>{stock}</td>
            <td><a id="{id}" class="btn btn-success" href="javascript:void(0)">取消</a></td>
		</tr>
</script>	

<script type="text/template" id="reward_tr_tpl">
<tr>
 <input class="span form-control" name="set_id" value="" type="hidden">
<td align="center">
	<div class="control-group">
	<div class="controls" style="margin:0;">
	<span>满</span>
	<input class="span form-control" name="meet" value="" type="text" style="width: 80px;" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')">
	<span>元</span>
	</div>
	</div>
</td>
<td>
 <div class="control-group reward-setting first-reward">
	<div class="controls">
	<label class="checkbox inline reward-label js-trigger-label">
	<input class="checked-status" name="cash_required" type="checkbox" value="1" onclick="checkStatus(this);">
	<span class="origin-status " style="display: inline-block;">减现金</span>
	<span class="replace-status js-response-label " style="display: none;">
	减
	<input class="span1 js-valid-input form-control" name="cash" value="" style="width: 80px;" type="text" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')">
	元
	</span>
	</label>
	</div>
</div>
<div class="control-group reward-setting">
	<div class="controls">
	<label class="checkbox inline reward-label">
	<input class="checked-status" name="postage" type="checkbox" value="1">
	<span class="origin-status">免邮</span>
	</label>
	</div>
</div>
<label class="status_error_msg" style="color:red;margin-left: 70px;"></label>
</td>
<td align="center">
<a class="gray js-remove-item" onclick="removeObj(this);">删除</a>
</td>
</tr>
</script>	 
[#include "/includes/footer.html" /]
<script>
Template.init("#menu-discount");
</script> 
</body>
</html> 